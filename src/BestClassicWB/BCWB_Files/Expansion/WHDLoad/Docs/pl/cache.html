<HTML>
<HEAD>
<TITLE>Obs³uga buforów procesorów</TITLE>
<meta name="DC.Language" content="pl">
<meta http-equiv="content-language" content="pl">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2">
<!-- $Id: cache.html 1.9 2014/12/04 23:37:38 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Przegl±d buforów procesorów</h3>

<h4>Uwaga od t³umacza! &quot;Bufor&quot; jest tutaj odpowiednikiem angielskiego s³owa
&quot;Cache&quot;!</h4>

Aby przyspieszyæ prêdko¶æ dzia³ania, niektóre procesory z rodziny 68k s± zdolne do
buforowania dostêpu do pamiêci.
<br>Odwo³ania do buforów wykonywane s± zawsze przy u¿yciu adresów logicznych, w³±czaj±c w to
kod funkcji dostêpu. Oznacza to, i¿ dostêp w Trybie U¿ytkownika i w Trybie
Nadzorcy tworzy inne wpisy w buforach (wiêcej informacji na ten temat
znajdziesz w dokumentacjach firmy Motorola).
<p>Poni¿ej znajduje siê przegl±d mo¿liwo¶ci buforowania procesorów z rodziny 68k:
<ul><li>68000
brak
<li>68010<ul>
<li>Instruction Prefetch
<br>dwa s³owa prefetch, jedno s³owo dekoduj±ce rejestr
<li>Tryb Pêtli
<br>uruchamiany jest, gdy za instrukcj± sk³adaj±c± siê z jednego s³owa wystêpuje instrkcja
DBcc zapêtlaj±ca do poprzedniej instrukcji, nie s± pobierame kolejne instrukcje a¿ do zakoñczenia pêtli
</ul><li>68020<ul>
<li>Instruction Prefetch
<br>jedno d³ugie s³owo
<li>Instruction Cache
<br>16 linii po 16 bajtów = 256 bajtów
<br>mo¿e zostaæ w³±czony lub zamro¿ony przez CACR
</ul><li>68030<ul>
<li>Instruction Prefetch
<br>jedno d³ugie s³owo
<li>Instruction Cache
<br>16 linii po 16 bajtów = 256 bajtów
<br>mo¿e zostaæ w³±czony lub zamro¿ony przez CACR
<li>Data Cache
<br>16 linii po 16 bajtów = 256 bajtów
<br>mo¿e zostaæ w³±czony lub zamro¿ony przez CACR
<br>zawsze WriteThrough
<br>wybierany tryb Write Allocation aby wymusiæ niewa¿no¶æ wpisów innych u¿ytkowników/nadzorców
<br>Tryb Burst wymusza orczytywanie ca³ych linii bufora za jednym razem o ile tylko sprzêt to obs³uguje
</ul><li>68040<ul>
<li>Instruction Prefetch
<br>jedno d³ugie s³owo
<li>Instruction Cache
<br>256 linii po 16 bajtów = 4096 bajtów
<br>mo¿e zostaæ w³±czony przez CACR
<li>Data Cache
<br>256 linii po 16 bajtów = 4096 bajtów
<br>mo¿e zostaæ w³±czony przez CACR
<br>wybierane tryby CopyBack/WriteThrough przez MMU
</ul><li>68060<ul>
<li>Instruction Prefetch
<br>jedno d³ugie s³owo
<li>Instruction Cache
<br>512 linii po 16 bajtów = 8192 bajtów
<br>mo¿e zostaæ w³±czony, zamro¿ony i zmniejszony o po³owê przez CACR
<li>Branch Cache
<br>mo¿e zostaæ w³±czony przez CACR
<br>nie wp³ywaj± na niego ustawienia MMU!
<li>Superscalar Dispatch
<br>mo¿e zostaæ w³±czony przez CACR
<li>Data Cache
<br>512 linii po 16 bajtów = 8192 bajtów
<br>mo¿e zostaæ w³±czony, zamro¿ony i zmniejszony o po³owê przez CACR
<br>wybierane tryby CopyBack/WriteThrough przez MMU
<li>Push Buffer
<br>mo¿e zostaæ wy³±czony przez PCR
<li>Store Buffer
<br>mo¿e zostaæ w³±czony przez CACR
<br>Strony pamiêci nie mog± byæ szeregowane &quot;bezbuforowo&quot; (dok³adnie)
</ul></ul>
<h4><a name="cache">Zarz±dzanie buforami w WHDLoad</a></h4>
Najwa¿niejsz± rzecz± jest zrozumienie, ¿e bufory procesorów 68030-68060
s± kontrolowane przez Rejestr Kontroli Buforów (Cache Control Register (CACR))
<b>i</b> MMU
<br>W CACR bufory zostaj± globalnie w³±czone lub wy³±czone. U¿ywaj±c
pojedynczych stron MMU (4 kilobajty z WHDLoad) zostanie zaznaczone jak maj± byæ
buforowane.
<br>Na 68030 strona pamiêci mo¿e byæ buforowalna lub nie. Na
68040/68060 mo¿e byæ buforowalna w trybach WriteThrough, buforowalnym
CopyBack, niebuforowalnym
(niedok³adnym) lub niebuforowalnym szeregowym (dok³adnym).
<p>Je¿eli MMU nie jest wykorzystywane przez WHDLoad, bufory kontrolowane s± tylko przez CACR.
<h4>Domy¶lne ustawienia buforów</h4>
Domy¶lnie obszary WHDLoad, .slave i ExpMem oznaczone s± jako buforowalne
poprzez CopyBack. Obszar BaseMem oznaczony jest jako niebuforowalny, a
Data i Instruction Cache s± w³±czone w CACR. Program umieszczony w obszarze
BaseMem uruchamia siê bez buforów, lecz WHDLoad i pliki .slave wykorzystuj±
bufory w celu zwiêkszenia efektywno¶ci. Je¶li MMU nie jest u¿ywane przez
WHDLoad ustawienie to skutkuje wy³±czeniem obu typów buforowania, poniewa¿
bez uk³adu MMU ró¿ne ustawienia dla ró¿nych obszarów pamiêci nie jest mo¿liwe,
dlatego je¶li jaki¶ obszar pamiêci zostanie ustwaiony jako &quot;NonCacheable&quot;
wszystkie bufory musz± zostaæ wy³±czone.

<h4>Kontrola buforów z poziomu Programisty</h4>
Wystêpuj± dwie funkcje resload kontroluj±ce bufory: <A
HREF="../autodoc.html#resload_SetCACR">resload_SetCACR</a> i <A
HREF="../autodoc.html#resload_SetCPU">resload_SetCPU</a>. Resload_SetCACR to starsza
procedura i mo¿e byæ w pe³ni zast±piona przez <a href="../autodoc.html#resload_SetCPU">resload_SetCPU</a> (WHDLoad wewnêtrznie
mapuje argumenty <a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a> i wywo³uje <a href="../autodoc.html#resload_SetCPU">resload_SetCPU</a>).
Zalecane jest korzystanie z <a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a> dla wszystkich tych, którzy nie
wiedz± wszystkiego o buforach i ich zachowaniu siê w systemie Amigi.
Wykorzystuj±c <a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a> Instruction i Data Cache mog± zostaæ osobno
w³±czone lub w³±czone. <a href="../autodoc.html#resload_SetCACR">resload_SetCACR</a> wp³ywa tylko na buforowalno¶æ obszaru BaseMem.
<h4>Kontrola buforów z poziomu U¿ytkownika</h4>
Je¿eli programista wykona³ wszystko prawid³owo, u¿ytkownik nie musi nic
zmieniaæ odno¶nie ustawieñ buforów, gdy¿ zosta³o to dokonane przez plik .slave.
<br>Niemniej jednak, mog± wyst±piæ dwie sytuacje, gdy konieczna jest rêczna zmiana ustawieñ buforów.
Pierwsza z nich, aby spowolniæ program (na przyk³ad, mo¿e siê to objawiaæ
b³êdami w grafice) oraz druga, aby przyspieszyæ program.
<p>Aby tego dokonaæ, mo¿na wykorzystaæ opcjê <a
href="opt.html#NoCache">NoCache</a>. Wy³±cza ona wszystkie bufory
i zaznacza ca³± pamiêæ jako niebuforowaln± szeregow± (dok³adn±). Je¿eli
komputer posiada 32-bitow± pamiêæ Chip, nadal wszystko bêdzie szybsze ni¿
na oryginalnej A500.
<p>Aby przyspieszyæ zainstalowany program, niektóre opcjê mog± zostaæ uaktywnione,
aby w³±czyæ bufory. Powoduj± one nadpisanie ustawieñ dokonanych przez plik .slave.
Na 68020 opcja
<a href="opt.html#Cache">Cache</a> mo¿e zostaæ ustawiona. Na 68030 opcja <a
href="opt.html#DCache">DCache</a> mo¿e zostaæ u¿yta (zawiera ona ju¿ w sobie opcjê
Cache). Na 68060 istnieje wiêcej opcji <a href="opt.html#BranchCache">BranchCache</a>,
<a href="opt.html#StoreBuffer">StoreBuffer</a> i
<a href="opt.html#SuperScalar">SuperScalar</a>. Opcja <a
href="opt.html#ChipNoCache">ChipNoCache/S</a> mo¿e wp³yn±æ na poprawê efektywno¶ci na
68040 i 68060.
<a name="chipmem"></a><h4>Buforowalno¶æ pamiêci Chip</h4>
Buforowalno¶æ mo¿e zostaæ ustawiona nie tylko przez sam procesor (CACR) i
ustawienia MMU, ale równie¿ przez zewnêtrzne urz±dzenia. Na szynie adresowej
procesor sygnalizuje próbê zbuforowania obszaru. Urz±dzenia zewnêtrzne
mog± sygnalizowaæ procesorowi (je¿eli adres zosta³ na³o¿ony na adres szyny
podczas próby dostêpu do pamiêci), ¿e dany obszar nie mo¿e zostaæ zbuforowany.
<br>Mechanizm, podczas którego urz±dzenie zewnêtrzne sygnalizuje procesorowi,
¿e pamiêæ nie mo¿e zostaæ zbuforowana, wykorzystywany jest (ZTCW) na wszystkich
Amigach i we wszystkich kartach procesorowych od 68030 wzwy¿ (z racji, ¿e
posiadaj± Data Cache). Wp³yw ma to na ca³± pamiêæ Chip oraz przestrzeñ IO
(Cia/Custom/RTC), która nie mo¿e zostaæ zbuforowana przez Data Cache.
Istotne jest, aby unikaæ niezgodno¶ci buforów, z powodu, dla przyk³adu, aktywno¶ci
DMA.
<br>Reakcja procesora na sprzêt, który odmawia zbuforowania obszaru jest ró¿na
na ró¿nych procesorach. Na 68030 nie wp³ywa na efektywno¶æ pracy - dane nie
zostan± zbuforowane. Na 68040 odczyt obszaru zostanie wykonany na pe³nej prêdko¶ci, lecz
zapis obszaru (CopyBack) zostanie usuniêty i uruchomiony ponownie bez
buforowalno¶ci, co spowoduje oko³o piêciokrotne (w zale¿no¶ci od procesora i innych
urz±dzeñ) spowolnienie dostêpu (w porównaniu do niezbuforowanego dostêpu).
Na 68060 odczyt i zapis zostanie usuniêty i uruchomiony ponownie. Odczyt
bêdzie oko³o 3 razy wolniejszy, a zapis do oko³o 5 razy.
<br>
Wspomniane rzeczy odnosz± siê do dostêpu do danych. Dostêp do instrukcji
zazwyczaj pozostaje bez zmian i jest buforowalny wewn±trz pamiêci Chip.
Istniej± pewne urz±dzenia (prawdopodobnie uszkodzone), które nie zezwalaj±
instrukcjom na bycie buforowanymi w pamiêci Chip. Na takich urz±dzeniach
opcja <a
href="opt.html#ChipNoCache">ChipNoCache/S</a> powinna zostaæ u¿yta, aby
unikn±æ najwiêkszych spowolnieñ.
<br>Mo¿na sprawdziæ to zachowanie poprzez uruchomienie <i>Speed.Slave</i>
znajduj±cego siê katalogu <tt>src/memory-speed</tt> w archiwum dla developerów.
<h4>Burst Mode</h4> Tryb Burst w 68030 nakazjue procesorowi zawsze odczytywaæ ca³± liniê
bufora (16 znaków), je¶li wystêpuj± braki w buforze zamiast tylko jednego ¿±danego s³owa.
Tryb Burst musi byæ obs³ugiwany przez sprzêt, je¶li nie jest, nie jest mo¿liwe odczytanie
zawarto¶ci bufora bez po¶wiêcenia na to dodatkowego czasu. Tryb Burst mo¿e byæ w³±czony
oddzielnie zarówno dla bufora instrukcji jak i danych. Poniewa¿ dostêp w trybie Burst
zabiera wiêcej czasu ni¿ pojednyczy dostêp, tryb Burst daje tylko przyspieszenie dzia³ania
je¶li wiêkszo¶æ wpisów z linii bufora zostanie tak¿e wykorzystana przezd opró¿nieniem
linii bufora. Dla bufora instrukcji tryb Burst zazwyczaj poprawia wydajno¶æ. Dla bufora danych
czêsto tylko w scenariuszach, gdzie wystêpuj± nastêpuj±ce po sobie odczyty pamiêci.
WHDLoad w³±cza tryb Burst instrukcji razem z buforowaniem instrukcji zaczynaj±c od wersji 18.0.
Tryb Burst dla bufora danych nie bêdzie w³±czany przez WHDLoad.
<h4>Write Allocation</h4>
Write Allocation kontroluje bufory na procesorze 68030 w sytuacji, gdy wystêpuje
utrata buforów podczas operacji zapisu. Write Allocation musi zostaæ w³±czony,
gdy fragmenty zainstalowanego programu uruchomione s± w trybie U¿ytkownika.
Je¿eli zainstalowany program uruchomiony jest w trybie Supervisor Mode Write Allocation,
Write Allocation mo¿e zostaæ wy³±czony, co mo¿e wp³yn±æ na minimaln± poprawê
efektywno¶ci.
<h4>Branch Cache</h4>
<p>Branch Cache (bufor ga³êziowy) dostêpny jest tylko na 68060. Jest to
rodzaj Instruction Cache dla tzw. instrukcji ga³êziowych. W odró¿nieniu
od Instruction Cache ustawienia MMU nie maj± wp³ywu na Branch Cache!
Oznacza to, ¿e nawet je¿eli odpowiednia strona pamiêci zaznaczona jest jako
niebuforowalna, instrukcje ga³êziowe bêd± buforowane (je¿eli tylko Branch Cache
jest w³±czony).</p>
<hr>W celu uzyskania dalszych informacji przeczytaj Motorola Microprocessors User Manuals.
Je¿eli masz jakie¶ uwagi dotycz±ce tego tematu <A
HREF="mailto:wepl@whdload.de">skontaktuj siê ze mn±</A>.
</BODY>
</HTML>

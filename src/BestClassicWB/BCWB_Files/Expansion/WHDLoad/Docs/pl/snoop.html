<HTML>
<HEAD>
<TITLE>Snooping</TITLE>
<meta name="DC.Language" content="pl">
<meta http-equiv="content-language" content="pl">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-2">
<!-- $Id: snoop.html 1.6 2014/12/04 23:37:38 wepl Exp wepl $ -->
</HEAD>
<BODY>
<h3>Snooping</h3>
<h4>Co to jest?</h4>
Snooping to jedna z cech WHDLoad, która dokonuje sprawdzania i odnotowuje
dostêpy do rejestrów CIA oraz rejestrów w³asnych.
Je¶li opcja <a href="opt.html#Snoop">Snoop</a> jest aktywna, wszystkie
nieprawid³owe i b³êdne próby dostêpu wygeneruj± b³±d dostêpu i przerwanie pracy
uruchamianego programu. WHDLoad wy¶wietli komunikat wyja¶niaj±cy powód niepowodzenia.

Wykorzystuj±c funkcjê <a
href="../autodoc.html#resload_Control">resload_Control</a> oraz znaczniki <a
href="../autodoc.html#WHDLTAG_CUST">WHDLTAG_CUST_DISABLE/READ/STROBE/WRITE</a>
mo¿na modyfikowaæ wewnêtrzn± konfiguracjê pakietu WHDLoad w kwestii tego, które rejestry
s± odczytywalne/zapisywalne. Dziêki temu niedozwolony dostêp mo¿e byæ ignorowany, lub te¿
dozwolony dostêp - wykryty. Te funkcje powinny byæ u¿ywane jedynie podczas tworzenia pliku .slave,
a nie w publicznych wydaniach instalatorów.

<h4>Rejestry w³asne</h4>
Wszystkie próby zapisu i odczytu rejestrów s± weryfikowane. Niedozwolone dzia³ania to:
<ul>
<li>dostêpy do nieistniej±cych rejestrów,
<li>odczyt z rejestrów oznaczonych jako przeznaczone &quot;tylko do zapisu&quot; (Write Only),
<li>zapis do rejestrów oznaczonych jako przeznaczone &quot;tylko do odczytu&quot; (Read Only),
<li>dostêpy do rejestrów wczesnego odczytu (Early Read),
<li>dostêpy typu &quot;byte write&quot; (za wyj±tkiem <tt>bltcon0l</tt> i <tt>aud*vol+1</tt>).
</ul>
Rejestry &quot;Strobe&quot; mog± byæ odczytywane i zapisywane. Zestaw sprawdzonych
rejestrów w³asnych mo¿e siê ró¿niæ w zale¿no¶ci od uk³adów graficznych: OCS
(Old ChipSet - A500, A1000, stara A2000), ECS (Enhanced ChipSet
- A600, nowa A2000, A3000) i AGA (Advanced Graphics - A1200, A4000). Jest to
u¿yteczne zw³aszcza przy wychwytywaniu b³êdów w starych programach.

<h4>Rejestry CIA</h4>
Podczas prób dostêpu do rejestrów CIA tylko próby zapisu s± weryfikowane. Oznacza to, ¿e 
próby odczytu nieistniej±cych rejestrów w obszarze pamiêcie  $bfd000...$bfefff nie zostan± wykryte. Dla wszystkich prób zapisu, zapisywane warto¶ci bêd± przechowywane wewnêtrznie przez WHDLoad. Dla niektórych rejestrów CIA s± dokonywane szczególne sprawdzenia w zale¿no¶ci od wpisywanej warto¶ci:

<p><table border=1 summary="Tabela rejestrów CIA">
<tr>
	<th>addres</th>
	<th>rejestr</th>
	<th>sprawdzenie</th>
</tr><tr>
	<td>$bfe001</td>
	<td>ciaa.ciapra</td>
	<td>ustawienie bitu Overlay #0 jest zabronione</td>
</tr><tr>
	<td>$bfe201</td>
	<td>ciaa.ciaddra</td>
	<td>bity #6-7 mog± posiadaæ dowoln± warto¶æ (u¿ywane przez joypady), ni¿sze bity musz± byæ ustawione na %000011</td>
</tr><tr>
	<td>$bfe801</td>
	<td>ciaa.ciatodlow</td>
	<td rowspan=3>dostêpy odczytu-zapisu-zmiany (na przyk³ad bchg) s± niedozwolone w przypadku ustawienia bitu ALARM w ciaa.ciacrb (sprawdzane tylko na procesorze 68060)</td>
</tr><tr>
	<td>$bfe901</td>
	<td>ciaa.ciatodmid</td>
</tr><tr>
	<td>$bfea01</td>
	<td>ciaa.ciatodhi</td>
</tr><tr>
	<td>$bfed01</td>
	<td>ciaa.ciaicr</td>
	<td>dostêpy odczytu-zapisu-zmiany (na przyk³ad bchg) s± niedozwolone (sprawdzane tylko na procesorze 68060)</td>
</tr><tr>
	<td>$bfd100</td>
	<td>ciab.ciaprb</td>
	<td>bity dla MOTOR #7, SELECT #3-6 i STEP #0 nie mog± byæ kasowane, pozosta³e bity mog± byæ zmieniane; dziêki temu ka¿da próba dostêpu do stacji dysków zostanie wykryta</td>
</tr><tr>
	<td>$bfd200</td>
	<td>ciab.ciaddra</td>
	<td>dopuszczalna zapisywana warto¶æ to %11000000</td>
</tr><tr>
	<td>$bfd300</td>
	<td>ciab.ciaddrb</td>
	<td>dopuszczalna zapisywana warto¶æ to %11111111</td>
</tr><tr>
	<td>$bfd800</td>
	<td>ciab.ciatodlow</td>
	<td rowspan=3>dostêpy odczytu-zapisu-zmiany (na przyk³ad bchg) s± niedozwolone w przypadku ustawienia bitu ALARM w ciaa.ciacrb (sprawdzane tylko na procesorze 68060)</td>
</tr><tr>
	<td>$bfd900</td>
	<td>ciab.ciatodmid</td>
</tr><tr>
	<td>$bfda00</td>
	<td>ciab.ciatodhi</td>
</tr><tr>
	<td>$bfdd00</td>
	<td>ciab.ciaicr</td>
	<td>dostêpy odczytu-zapisu-zmiany (na przyk³ad bchg) s± niedozwolone (sprawdzane tylko na procesorze 68060)</td>
</tr></table>


<h4>Jak to dzia³a?</h4>
Je¿eli opcja &quot;Snoop&quot; jest w³±czona, WHDLoad zaznacza w drzewie
translacji MMU adresy rejestrów CIA i rejestrów w³asnych
jako nieprawid³owe/zabezpieczone przed zapisem. Z tego powodu ka¿dy dostêp do rejestrów w³asnych lub/i CIA
generuje b³±d dostêpu. WHDLoad wówczas sprawdza, czy próba dostêpu by³a prawid³owa.
Je¿eli oka¿e siê, ¿e nie by³a, nast±pi przerwanie wykonywanego programu. Je¿eli
próba dostêpu jest prawid³owa i wyst±pi³a operacja odczytu, zostanie ona zaemulowana
i bêdzie kontynuowane wykonywanie programu. Je¿eli wyst±pi³a operacja zapisu,
WHDLoad odpowiednio dokonana zapisu warto¶ci wewnêtrznego schowka.
<br>Zaznaczanie obszarów pamiêci oraz emulacja poci±gaj± za sob±
zwolnienie wykonywania programu. Jak bardzo, to zale¿y od typu procesora
oraz typu pamiêci graficznej (16/32-bit), a tak¿e od ustawienia wska¼nika stosu.
Zale¿ne jest to równie¿ od typu dostêpu (Bajt/S³owo/D³ugie S³owo, Zapis/Odczyt).
Na 68030 zapis jest szybszy ni¿ odczyt
(gdy¿ odczyt stosu zajmuje 92 bajty, a zapis 32 bajty), na
68060 odczyt jest szybszy, poniewa¿ emulacja zapisu jest bardziej z³o¿ona.

<h4>Tryb &quot;Fast Snoop&quot;</h4>
Opcja <a href="opt.html#Snoop">Snoop/S</a> uaktywnia szybki snooping.
Dostêpy odczytu nie bêd± sprawdzane. Równie¿ nie s± prowadzone oznaczenia.
Ten tryb mo¿e byæ przydatny w celu zdobycia zawarto¶ci rejestrów w³asnych, np.
zapisania obrazka przy wykorzystaniu programu <a href="sp.html">SP</a>.

<h4>Skaner copperlisty</h4>
Od WHDLoad w wersji 13 sprawdzana jest równie¿ copperlista. Skaner
zostaje uaktywniony podczas zapisu do rejestrów <tt>coplc</tt> je¶li
DMA coppera jest w³±czone lub wtedy, gdy zainstalowany program w³±cza DMA coppera
poprzez zapis do rejestrów <tt>dmacon</tt>.
Skaner pod±¿a za copperlist±, sprawdza i ustawia wszystkie instrukcje Move
zgodnie z restrykcjami opcji Snoop (OCS/ECS/AGA).
Instrukcje Skip i Wait (za wyj±tkiem CEND) s± ignorowane. Gdy zostanie
odnaleziona nieprawid³owa próba dostêpu, zainstalowany program zostanie
wy³±czony. Skaner pod±¿y za odga³êzieniami
(<tt>copjmp</tt>), wykryje pêtle i sprawdzi do 16 podlist. Instrukcje
Move w copperli¶cie zostan± zapisane do wêwnêtrznego pliku rejestru,
który zostanie zapisany na dysk przy wyj¶ciu z WHDLoad. Skaner jest
nieaktywny w trybie &quot;Fast Snoop&quot;.

<h4>Sprawdzanie wska¼ników audio</h4>
Gdy opcja <a href="opt.html#ChkAudPt">ChkAudPt/S</a> jest w³±czona, WHDLoad sprawdza,
czy zainstalowany program zapisuje tylko poprawne adresy do w³asnych wska¼ników audio DMA.
Poprawne wska¼niki oznaczaj± ¿e wskazywany jest adres wewm±trz BaseMem i ró¿ny od 0.
Sprawdzane s± tylko operacje zapisu d³ugich s³ów. Zapisywanie s³ów nie jest sprawdzane.
Sprawdzenie to mo¿e byæ u¿yteczne w wyszukiwaniu problemów w procedurach odtwarzania d¼wiêku.

<h4>Sprawdzanie priorytetu blittera</h4>
Gdy opcja <a href="opt.html#ChkBltHog">ChkBltHog/S</a> jest w³±czona, WHDLoad sprawdza, czy zainstalowany program
nie w³±cza bitu <tt>BltHog</tt> poprzez zapis do rejestru <tt>dmacon</tt>.
Priorytet blittera mo¿e powodowaæ problemy na niektórych konfiguracjach
w po³±czeniu z du¿ymi operacjami na blitterze (wykorzystanie wszystkich kana³ów).

<h4>Sprawdzanie rozmiaru blittera</h4>
Gdy opcja <a href="opt.html#ChkBltSize">ChkBltSize/S</a> jest w³±czona, WHDLoad sprawdza, czy zadania blittera
nie próbuj± przedostaæ siê poza pamiêæ okre¶lon± w BaseMem. Podczas próby
zapisu do <tt>bltsize</tt> lub <tt>bltsizh</tt> sprawdza, czy tryb linii jest w³±czony
w <tt>bltcon1</tt>. Je¿eli jest w³±czony, zostanie zignorowane sprawdzanie rozmiaru.
W przeciwnym razie WHDLoad wyliczy pierwsze i ostatnie s³owo dla ka¿ego
uaktywnionego kana³u DMA. Je¿eli jeden adres znajduje siê poza obszarem
BaseMem, program zostanie wy³±czony z odpowiedni± informacj± w oknie
komunikatu.
Obliczenia zosta³y zaprojektowany w taki sposób, aby wspó³pracowa³y
ze wszystkimi trybami (rosn±cy/malej±cy, pozytywny/negatywny, nieparzyste
modu³y/wska¼niki).
<br>Pamiêtaj, ¿e tryb rysowania linii nie jest sprawdzany i wszystkie rejestry
blittera mog± byæ zapisane do coppera je¶li bit <tt>copcon</tt> jest ustawiony.

<h4>Sprawdzanie oczekiwania blittera</h4>
Gdy opcja <a href="opt.html#ChkBltWait">ChkBltWait/S</a> jest w³±czona WHDLoad u¿yje instrukcji ¶ledzenia, aby
sprawdziæ, czy zainstalowany program wykonuje poprawienie oczekiwanie na
zakoñczenie wykonywania operacji blittera, zanim ten rozpocznie wykonywaæ
kolejn±. Wykorzystywana jest do tego wewnêtrzna zmienna, która reprezentuje
stan pracy blittera. Zmienna jest ustawiona, gdy dokonywany jest zapis
do <tt>bltsize</tt> lub <tt>bltsizh</tt>. Zmienna jest czyszczona,
gdy dokonywany jest odczyt z rejestru <tt>dmaconr</tt>.
Przy ka¿dorazowym zapisie do rejestru blittera sprawdzana jest wewnêtrzna
zmienna. Je¿eli wykazuje ona pracê blittera, wykonywanie zainstalowanego programu
zostanie przerwane, a WHDLoad zg³osi PC ostatniej czynno¶ci wykonywanej
przez blitter.
<br>Istniej± dwa &quot;w±skie gard³a&quot; tej opcji. Pierwsze to takie, ¿e nie
jest sprawdzane wykorzystanie blittera poprzez coppera, drugie - wykorzystanie
przerwañ blittera.

<h4>Sprawdzanie zerwania koloru</h4>
Gdy opcja <a href="opt.html#ChkColBst">ChkColBst/S</a> jest w³±czona, WHDLoad sprawdza,
czy podczas ka¿dego zapisu do rejestru <code>custom.bplcon0</code> bit
<code>color</code> jest ustawiony. Niektóre urz±dzenia, a w szczególno¶ci flickerfixer-y
wymagaj±, by ten bit by³ ustawiony w celu generowania poprawnego sygna³u wizyjnego na wyj¶ciu.
W celu zapewnienia jak najlepszej zgodno¶ci bit ten zawsze powinien byæ ustawiony.
Sprawdzane s± bezpo¶rednie zapisy do <code>custom.bplcon0</code> oraz wpisy dokonywane przez
copperlistê.

<h4>Copper Control Check</h4>
Gdy opcja <a href="opt.html#ChkCopCon">ChkCopCon/S</a> jest w³±czona, WHDLoad sprawdza,
czy podczas ka¿dego zapisu do rejestru <code>custom.copcon</code> bit #1 nie jest ustawiony.
Bit ten w³±cza mo¿liwo¶æ zapisywania rejestrów Blittera przez Coppera. Czasami mo¿e to byæ
przydatne przy wykrywaniu czy program u¿ywa Coppera do kontroli aktywno¶ci DMA.

<h4>Przysz³o¶æ</h4>
Planujê dodanie funkcji podobnych do zamra¿ania (Freezing) i ikonifikacji (Iconifing)
Zalecane jest, aby autorzy programów instalacyjnych sprawdzali swoje pliki .slave z opcj±
&quot;Snoop&quot;, aby zapewniæ sobie kompatybilno¶æ w przysz³o¶ci.

<h4>Wymagania</h4>
Dla opcji &quot;Snoop&quot; wymagane jest MMU. WHDLoad musi
<a href="mmu.html#usercontrol">u¿ywaæ</a> MMU, a z racji tej <a
href="opt.html#MMU">MMU/S</a> musi byæ w³±czony na procesorach 68030.
<h4>Ograniczenia</h4>
<ul>
<li>68020 + 68851
<ul>
<li>Nie jest obs³ugiwany.
</ul>
<li>68030
<ul>
<li>Dostêp do odczytu-zapisu-modyfikacji rejestrów CIA nie s± wykrywane.
</ul>
<li>68040
<ul>
<li>Dostêp do odczytu-zapisu-modyfikacji rejestrów CIA nie s± wykrywane.
<li>Instrukcja <tt>movem</tt> mo¿e wywo³ywaæ dostêpy do nieprawid³owych
rejestrów bez wygenerowania b³êdu dostêpu. Jest to mo¿liwe gdy¿
tylko pierwsza próba dostêpu jest sprawdzana.
<li>Instukcje nie mog± odwo³ywaæ siê do wiêcej ni¿ jednego ¶ledzonego rejestru w tym samym czasie.
Oznacza to, ¿e np. kod <tt>move.b ($dff006),($bfd800)</tt> nie mo¿e zostaæ
wykonany. Je¿eli taki kod wyst±pi w programie, WHDLoad poka¿e komunikat o
b³êdzie dostêpu.
</ul>
<li>68060
<ul>
<li>Instrukcja <tt>movem</tt> mo¿e wywo³ywaæ dostêpy do nieprawid³owych
rejestrów bez wygenerowania b³êdu dostêpu. Jest to mo¿liwe gdy¿
tylko pierwsza próba dostêpu jest sprawdzana.
<li>Instrukcja <tt>move &lt;rejestr CIA/w³asny&gt;,sr</tt> jest wykonywana
nieprawid³owo.
<li>Jakakolwiek instrukcja <tt>(ssp)+</tt> lub <tt>-(ssp)</tt> w po³±czeniu z
zapisem do rejestrów CIA lub rejestrów w³asnych nie mo¿e zostaæ wykonana z powodu
problemów z ramk± stosu. WHDLoad wykrywa takie próby dostêpu i informuje
o nich stosownym komunikatem.
<li>Instukcje nie mog± odwo³ywaæ siê do wiêcej ni¿ jednego ¶ledzonego rejestru w tym samym czasie.
Oznacza to, ¿e np. kod <tt>move.b ($dff006),($bfd800)</tt> nie mo¿e zostaæ
wykonany. Je¿eli taki kod wyst±pi w programie, WHDLoad poka¿e komunikat o
b³êdzie dostêpu.
</ul>
</ul>
</BODY>
</HTML>
